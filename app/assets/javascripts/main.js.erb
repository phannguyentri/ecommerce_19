$(document).ready(function() {

  $('.change-status').on('click', function(e) {
    e.preventDefault();
    id = $(this).attr('id');
    access = $(this).parents('table').attr('data-user')
    namespace = '/admin'
    if (access == 'user') {
      namespace = ''
    }
    status = $(this).attr('data-status');
    $.ajax({
      type: 'put',
      url : namespace + '/orderitems/' +id,
      dataType: 'json',
      context: this,
      data: {
        orderitem: {
          status: status
        }
      },
      success: function(response) {
        $(this).attr('data-status', check_status(status, 'false', 'true'));
        $(this).parent().parent().find('.status')
          .removeClass(check_status(status, 'label-danger', 'label-success'))
          .addClass(check_status(status, 'label-success', 'label-danger'))
          .text(check_status(status, '<%= I18n.t("view.placed") %>',
            '<%= I18n.t("view.cancel") %>'));
      },
      error: function(error_message) {
        alert(error_message.responseText);
      }
    });
  });

  $('.delete-cartitem').on('click', function(e) {
    e.preventDefault();
    if (confirm('<%= I18n.t("view.sure?") %>')) {
      id = $(this).parent().attr('id');
      $.ajax({
        type: 'delete',
        url : '/cartitems/'+id,
        dataType: 'json',
        context: this,
        success: function(response) {
          $(this).parents('tr').remove();
        },
        error: function(error_message) {
          alert(error_message.responseText);
        }
      });
    }
  });

  $('.change-quantity').bind('change', function() {
    quantity = $(this).val();
    $(this).parent().next().find('.btn-change-quantity').removeClass('disabled')
      .attr('data-status', 'active');

  });
  $('.btn-change-quantity').click(function(event) {
    if ($(this).attr('data-status') != 'disabled'){
      id = $(this).parent().attr('id');
      quantity = parseInt($(this).parent().prev().find('input').val());
      $.ajax({
        type: 'put',
        url : '/cartitems/'+id,
        dataType: 'json',
        context: this,
        data: {
          cartitem: {
            quantity: quantity
          }
        },
        success: function(response) {
          $(this).addClass('disabled').attr('data-status', 'disabled');;
          alert('<%= I18n.t("view.cartitems.index.update-success") %>');
          $('#total').text(calculate_update_total());
        },
        error: function(error_message) {
          alert(error_message.responseText);
        }
      });
    }
  });

});

function check_status(status, case1, case2){
  return status == 'true' ? case1 : case2;
}

function calculate_update_total(){
  var total = 0;
  $('table#cart').find('td[data-th="Price"]').each (function() {
    var quantity = $(this).next().find('input').val();
    var price = $(this).text();
    total += price*quantity;
  });
  return total;
}
